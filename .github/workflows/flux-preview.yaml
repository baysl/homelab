name: Flux Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [closed]

jobs:
  flux-preview:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          cat <<EOF > ~/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              insecure-skip-tls-verify: true
            name: homelab
          contexts:
          - context:
              cluster: homelab
              user: flux-preview
            name: homelab
          current-context: homelab
          users:
          - name: flux-preview
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF

      - name: Patch Flux to use PR branch
        run: |
          kubectl patch gitrepository flux-system -n flux-system \
            --type merge \
            -p "{\"spec\":{\"ref\":{\"branch\":\"${{ github.head_ref }}\"}}}"

  flux-reset:
    if: github.event.pull_request.state == 'closed'
    runs-on: ubuntu-latest

    steps:
      - uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          cat <<EOF > ~/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              insecure-skip-tls-verify: true
            name: homelab
          contexts:
          - context:
              cluster: homelab
              user: flux-preview
            name: homelab
          current-context: homelab
          users:
          - name: flux-preview
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF

      - name: Reset Flux to main
        run: |
          kubectl patch gitrepository flux-system -n flux-system \
            --type merge \
            -p '{"spec":{"ref":{"branch":"main"}}}'
